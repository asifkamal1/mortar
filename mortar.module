<?php
module_load_include('inc', 'mortar', 'mortar.node-access');
module_load_include('inc', 'mortar', 'mortar.field-access');
module_load_include('inc', 'mortar', 'mortar.send-email');
module_load_include('inc', 'mortar', 'mortar.view-alter');
module_load_include('inc', 'mortar', 'mortar.user-alter');
module_load_include('inc', 'mortar', 'mortar.cd-node-alter');
module_load_include('inc', 'mortar', 'mortar.tr-node-alter');
module_load_include('inc', 'mortar', 'mortar.miscellaneous');
module_load_include('inc', 'mortar', 'mortar.wf-node-alter');

/*
 *Prepare node to be displayed
 * 
 */
function mortar_node_view_alter(&$build) {
    //Checks if node is SOP
     
    if($node_load = menu_get_object()) {
        $node = node_load($node_load -> nid);
    }
    else {
        return;
    }

    //load user details
    global $user;
    $account = user_load($user -> uid);    
    
    if($node->type == 'controlled_document' ) {
        mortar_controlled_document_node_view_alter($build, $account, $node);
    }
}


/*
 *Adds access options to content types. 
 */
function mortar_node_access($node, $op, $account) {

    if(!isset($node -> type)) {
        return NODE_ACCESS_IGNORE;
    }
    
    if($node->type == 'ctu' ) {
        //function in node-access.inc
        return mortar_ctu_access($node, $op, $account);
    }
    
    if($node->type == 'controlled_document' ) {
        //function in node-access.inc
        return mortar_controlled_document_access($node, $op, $account);
    }
    

    if($node->type == 'training_record' ) {
        //function in node-access.inc
        return mortar_training_record_access($node, $op, $account);
    }
    
}


/*
 *
 */
function mortar_node_view($node, $view_mode, $langcode) {
    if($node -> nid == 4175) {
        $node -> content['#fieldgroups']['group_all_sops'] -> label = 'My Controlled Documents';
        $node -> content['#fieldgroups']['group__all_sop_append'] -> label = 'Review Emails';
        $node -> content['#fieldgroups']['group_process_map'] -> weight = '60';
    }
    
    if($node -> type == "cds_display"){
        mortar_cd_process_setup($node, $view_mode, $langcode);
    }
    
    /*
    * Check the user have access permission to OCTO guidelines if not then hide the Horizentale tab from the menu
    */
    global $user;
    $account = user_load($user -> uid);
    $ctu_list = array();
    for($count = 0; $count < count($account -> field_ctu['und']); $count++) {
       $ctu_list[] = $account -> field_ctu['und'][$count][target_id];  
    }
    
    if (in_array('457', $ctu_list, true)) {
       // dpm('found');
    } else {
        $node -> field_view_ht_6 = array();
        $node -> content['field_view_ht_6'] = array();
    }
}


/*
 *
 */
function mortar_form_alter(&$form, &$form_state, $form_id) {
    global $user;
    
    if($form_id == 'views_form_training_record_desktop_display_ol' && isset($form['from'])) {
        //function 
        mortar_training_record_reminder_view_send_email($form, $form_state, $form_id);
    }

    if($form_id == 'views_form_training_record_desktop_display_admin' && isset($form['from'])) {
        //function 
        mortar_training_record_reminder_view_send_email($form, $form_state, $form_id);
    }
    
    if($form_id == 'views_form_all_training_record_related_to_sops_report_page' && isset($form['from'])) {
        //function (for all sop view)
        mortar_training_record_all_sop_view_send_email($form, $form_state, $form_id);
    }
    
    if(($form_id == 'user_profile_form' || $form_id == 'user_register_form') && !in_array('administrator', $user -> roles) && in_array('mortar administrator', $user -> roles)) {
        //function in 
        mortar_user_profile_form_alter($form, $form_state, $form_id, $user);
    }    
    #debug($form_id); user_register_form'
    
    if($form_id == 'user_register_form' || $form_id == 'user_profile_form'){
        $form['#validate'][] = 'mortar_form_validate';
        return $form;
    }
    
    
    
}


function mortar_form_validate($form, &$form_state) {
    
    // If previous validation didn't pass, return
    //if (form_get_errors()) return;

    global $client_taleo, $user, $taleo_id;
    
    $mail = $form_state['values']['mail'];
    
    if(empty($mail)) {
        return;
    }
    
    //check 1, to see user email exist
    $user_exist_check = user_load_by_mail($mail);
    
    //check 2, to  see user email exist
    $exist = db_select('users', 'us')
        ->fields('us')
        ->condition('mail', $mail, '=')
        ->execute()
        ->rowCount();
    
    if ($exist && !empty($user_exist_check)) {
        
        $error = array();
        $errors = form_get_errors();
        
        //check for  mondatory filed data
        if(!empty($errors['field_job_title][und']) ||
        !empty($errors['field_last_name][und][0][value']) ||
        !empty($errors['field_first_name][und][0][value']) ||
        !empty($errors['field_ctu][und']) ) {
            return;
        }
        
        $user_in = user_load_by_mail($mail); 
        $role_name = 'mortar user';
        $uid = $user_in->uid;
        
        $role = user_role_load_by_name($role_name);

        //if user is not mortar user then add the role of 'mortar user' and CV, JD, GCP training records to this user account
        if(in_array('mortar user', $user_in -> roles) ||
           in_array('administrator', $user_in -> roles) ||
           in_array('mortar reviewer', $user_in -> roles) ||
           in_array('mortar author', $user_in -> roles) ||
           in_array('mortar administrator', $user_in -> roles) ||
           in_array('mortar compliance reviewer', $user_in -> roles) ||
           in_array('mortar operational lead', $user_in -> roles)) {

            return;
        }
        else {
            user_multiple_role_edit(array($uid), 'add_role', $role->rid);
            
            //add the the mondatory filed data
            $user_in->field_last_name['und'][0]['value'] = $form_state['values']['field_last_name']['und'][0]['value'];
            $user_in->field_first_name['und'][0]['value'] = $form_state['values']['field_first_name']['und'][0]['value'];
            
            $limit = count($form_state['values']['field_ctu']['und']);
            for ($i = 0; $i < $limit; $i++) {
                $user_in->field_ctu['und'][$i]['target_id'] = $form_state['values']['field_ctu']['und'][$i]['target_id'];
            }    
            
            $user_in->field_job_title['und'][0]['target_id'] = $form_state['values']['field_job_title']['und'][0]['target_id'];
    
            $trainee_id = $uid;
            $training_requests = array(35, 36, 37); //CV, JD, GCP
            $training_record_counter = 0;
            
            foreach($training_requests as $training_request) {
                
                $training_type = $training_request;
                $has_training = mortar_has_training_record($trainee_id, $training_type, $training_name = NULL, $controlled_doc_id = NULL, $controlled_doc_v = NULL);
                
                if($has_training == NULL) {
                    $node = new stdClass(); // We create a new node object
                    $node -> type = "training_record"; // Or any other content type you want
                    $node -> language = LANGUAGE_NONE; // Or any language code if Locale module is enabled. More on this below *
                    
                    node_object_prepare($node); // Set some default values.
                    
                    $node -> uid = $trainee_id; // Or any id you wish
                    $node -> field_training_type[$node->language][0]['target_id'] = $training_type;
                    $node -> field_training_status[$node->language][0]['target_id'] = 34;
                    $node -> field_trainee[$node->language][0]['target_id'] = $trainee_id;
                    $node = node_submit($node);
                    node_save($node);
                    
                    $training_record_counter += 1;
                }
            }
            
            if($training_record_counter != 0) {
                //clear all error amd warnig messages
                $error_messages = drupal_get_messages('error');
                unset($error_messages[$name]);
                
                //clear all error amd warnig messages
                $error_messages = drupal_get_messages('warning');
                unset($error_messages[$name]);
                
                drupal_set_message(t($user_in -> name.'  already exist in OCTRU system so a mortar user role is assigned to this user and also CV, GCP and job description are added to his/her training record'), 'status');
                drupal_set_message(t($training_record_counter . ' Training Request(s) added.'), 'status');
            }
            else {
                //clear all error amd warnig messages
                $error_messages = drupal_get_messages('warning');
                unset($error_messages[$name]);
                
                //clear all error amd warnig messages
                $error_messages = drupal_get_messages('error');
                unset($error_messages[$name]);
                
                drupal_set_message(t($user_in -> name.' already exist in OCTRU system so a mortar user role is assigned to this user Training Records already exists in  {'. $user_in -> name .'} account'), 'warning');
            }
            
            user_save($user_in);
        } 
    } 
}



/*
 * Implements hook_menu_alter().
 */
function mortar_menu_alter(&$items) {
    //custom diff access
    $items['node/%node/revisions']['access arguments'] = array(1);
    $items['node/%node/revisions']['access callback'] = 'mortar_node_revision_access';
   
}


/*
 *
 */
function mortar_css_alter(&$css) {
    #debug($css);
    //add correct css
    
    $css['sites/all/modules/octru/mortar/mortar-main.css'] = array(
                                                                'data' => drupal_get_path('module', 'mortar') . '/mortar-main.css',
                                                                'every_page' => true,
                                                                'media' => 'all',
                                                                'type' => 'file',
                                                                'weight' => 999,
                                                                'preprocess' => true,
                                                                'browsers' => 
                                                                    array (
                                                                        'IE' => true,
                                                                        '!IE' => true,
                                                                    ),
                                                                'group' => 0,
                                                              );
    global $base_url;
    
    if (strpos($base_url,'test') !== false) {
        $css['sites/all/modules/octru/mortar/mortar-test.css'] = array(
                                                                        'data' => drupal_get_path('module', 'mortar') . '/mortar-test.css',
                                                                        'every_page' => true,
                                                                        'media' => 'all',
                                                                        'type' => 'file',
                                                                        'weight' => 999,
                                                                        'preprocess' => true,
                                                                        'browsers' => 
                                                                            array (
                                                                                'IE' => true,
                                                                                '!IE' => true,
                                                                            ),
                                                                        'group' => 0,
                                                                      );
        #drupal_add_css(drupal_get_path('module', 'mortar') . '/mortar-dev.css');
    }
    else if (strpos($base_url,'dev') !== false) {
        $css['sites/all/modules/octru/mortar/mortar-dev.css'] = array(
                                                                        'data' => drupal_get_path('module', 'mortar') . '/mortar-dev.css',
                                                                        'every_page' => true,
                                                                        'media' => 'all',
                                                                        'type' => 'file',
                                                                        'weight' => 999,
                                                                        'preprocess' => true,
                                                                        'browsers' => 
                                                                            array (
                                                                                'IE' => true,
                                                                                '!IE' => true,
                                                                            ),
                                                                        'group' => 0,
                                                                      );
        #drupal_add_css(drupal_get_path('module', 'mortar') . '/mortar-dev.css');
    }
    else {
        #drupal_add_css(drupal_get_path('module', 'mortar') . '/mortar-live.css');
        $css['sites/all/modules/octru/mortar/mortar-live.css'] = array(
                                                                        'data' => drupal_get_path('module', 'mortar') . '/mortar-live.css',
                                                                        'every_page' => true,
                                                                        'media' => 'all',
                                                                        'type' => 'file',
                                                                        'weight' => 999,
                                                                        'preprocess' => true,
                                                                        'browsers' => 
                                                                            array (
                                                                                'IE' => true,
                                                                                '!IE' => true,
                                                                            ),
                                                                        'group' => 0,
                                                                       );
    }
 
}

/**
 * Access callback for the node revisions page.
 */
function mortar_node_revision_access($node, $op = 'view') {
    global $user;
    
    if(in_array('administrator', $user -> roles) || in_array('mortar administrator', $user -> roles)) {
        return TRUE;
    }
    //default diff     
    $may_revision_this_type = variable_get('diff_enable_revisions_page_node_' . $node->type, TRUE) || user_access('administer nodes');
    
    if($node -> type == 'controlled_document') {
        //4 = Active - Undergoing revision, 6 - Draft 
        $cd_status = $node -> field_status['und'][0]['target_id'] == 4 || $node -> field_status['und'][0]['target_id'] == 6;
    }
    else {
        $cd_status = TRUE;
    }
    //author
    $node_uid = $node -> uid == $user -> uid;
    
    return $may_revision_this_type && _node_revision_access($node, $op) && $cd_status && $node_uid;


}


/*
 * Implements hook_node_presave().
 */
function mortar_node_presave($node){
    if(isset($node->log) && !empty($node->log)){
        $tid = $node->field_review_version_number['und'][0]['tid'];
        $term = taxonomy_term_load($tid);
        $name = $term->name;
        $node->log = 'Review Version Number ('.$name.') - '.$node->log;
    }
}


/*
 * Including Process map using html5 map and for highlighting each image on hover event with maphighlight.js file.
*/
function mortar_cd_process_setup($node, $view_mode, $langcode) {
    $node -> content['field_process_map'][0]['#markup'] = '	
            <img src="/sites/default/files/new_process_map.png" alt="process map" class="map" usemap="#ImageMap" />
            <map name="ImageMap">
            
                    <area alt="" title="of-004" href="/controlled-doc/form/004" shape="poly" coords="28,69,30,125,164,122,162,68" />
                    <area alt="" title="gen-004" href="/controlled-doc/sop/gen-004" shape="poly" coords="223,62,225,121,349,116,346,61" />
                    <area alt="" title="gen-309" href="/controlled-doc/sop/gen-039" shape="poly" coords="651,61,653,120,730,118,729,62" />
                    
                    
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-005" shape="poly" coords="12,209,105,210,104,260,13,268" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-052" shape="poly" coords="121,208,122,263,221,253,222,208" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-010" shape="poly" coords="262,174,261,229,346,225,345,174" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-001" shape="poly" coords="357,179,359,211,445,210,445,178" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-004" shape="poly" coords="458,177,458,232,545,226,544,178" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-008" shape="poly" coords="558,178,560,222,639,216,638,180" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-051" shape="poly" coords="651,178,653,231,752,225,753,180" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-030" shape="poly" coords="11,281,11,325,87,324,90,281" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-029" shape="poly" coords="101,265,101,313,179,301,178,264" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-011" shape="poly" coords="255,239,342,237,343,283,254,293" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-002" shape="poly" coords="353,217,353,269,429,263,431,216" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-006" shape="poly" coords="455,238,457,271,526,269,527,234" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-016" shape="poly" coords="566,230,564,279,639,273,640,231" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-034" shape="poly" coords="27,338,28,402,125,393,125,340" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-035" shape="poly" coords="163,309,167,354,238,349,240,309" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-013" shape="poly" coords="261,299,261,358,331,356,335,298" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-003" shape="poly" coords="356,276,356,330,426,328,428,277" />
                    <area alt="" title="" href="/controlled-doc/sop/stats-002" shape="poly" coords="453,282,452,332,558,333,557,279" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-017" shape="poly" coords="602,279,603,334,679,329,682,280" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-018" shape="poly" coords="132,361,135,404,222,400,224,363" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-036" shape="poly" coords="261,368,261,407,334,409,333,366" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-005" shape="poly" coords="347,341,349,407,449,404,447,341" />
                    <area alt="" title="" href="/controlled-doc/sop/stats-001" shape="poly" coords="459,347,459,403,518,400,516,346" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-056" shape="poly" coords="524,341,524,399,600,397,600,340" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-037" shape="poly" coords="611,356,609,396,684,396,682,355" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-019" shape="poly" coords="691,345,693,393,758,390,754,350" />
                    
                    
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-027" shape="poly" coords="10,426,11,475,97,469,97,424" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-029" shape="poly" coords="98,471,99,505,174,502,173,470" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-009" shape="poly" coords="13,510,13,556,103,552,101,508" />
                    <area alt="" title="" href="/controlled-doc/sop/stats-003" shape="poly" coords="18,564,110,563,113,609,18,615" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-028" shape="poly" coords="102,422,104,459,185,459,183,424" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-032" shape="poly" coords="201,472,201,507,298,503,299,469" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-010" shape="poly" coords="123,515,123,567,209,561,208,516" />
                    <area alt="" title="" href="/controlled-doc/sop/stats-006" shape="poly" coords="155,573,159,617,251,616,254,572" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/stats-000" shape="poly" coords="190,421,191,462,305,460,306,424" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-023" shape="poly" coords="218,515,217,556,305,553,305,514" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-042" shape="poly" coords="268,567,267,608,348,608,349,566" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-011" shape="poly" coords="311,420,310,473,401,471,401,419" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-007" shape="poly" coords="311,499,312,552,408,545,407,499" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-012" shape="poly" coords="355,565,355,616,436,608,436,564" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-033" shape="poly" coords="483,423,485,471,409,475,409,425" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-022" shape="poly" coords="413,493,413,551,489,547,488,496" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-043" shape="poly" coords="449,559,450,617,514,615,513,559" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-014" shape="poly" coords="491,423,489,475,566,473,566,423" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-015" shape="poly" coords="501,491,501,548,586,541,587,491" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-020" shape="poly" coords="531,557,530,612,582,608,580,558" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/stats-004" shape="poly" coords="571,423,571,476,663,475,664,421" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-010" shape="poly" coords="602,484,601,535,671,531,669,486" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-024" shape="poly" coords="596,544,595,620,671,616,671,543" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-025" shape="poly" coords="671,425,670,469,763,469,762,426" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-026" shape="poly" coords="684,478,685,536,763,532,763,479" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-040" shape="poly" coords="683,543,684,621,745,613,744,545" />
                    
                    
                                                                                                                                                                  
                    <area alt="" title="" href="/controlled-doc/sop/gen-045" shape="rect" coords="11,631,88,687" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-044" shape="rect" coords="92,631,187,685" />
                    <area alt="" title="" href="/controlled-doc/sop/dm-011" shape="rect" coords="194,633,277,684" />
                    <area alt="" title="" href="/controlled-doc/sop/stats-005" shape="rect" coords="283,633,380,682" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-046" shape="rect" coords="382,632,480,683" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-048" shape="rect" coords="485,633,573,683" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-047" shape="rect" coords="579,632,673,687" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-050" shape="rect" coords="679,631,761,686" />
                    
                    
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-001" shape="poly" coords="788,38,788,77,904,75,903,37" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-007" shape="poly" coords="783,90,784,138,887,137,886,93" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-002" shape="poly" coords="772,151,772,206,846,205,846,148" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-008" shape="poly" coords="854,150,854,212,921,209,918,148" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-003" shape="poly" coords="769,216,770,255,851,254,850,216" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-006" shape="poly" coords="857,222,915,223,915,275,857,284" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-054" shape="poly" coords="772,264,770,323,846,314,850,264" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-055" shape="poly" coords="853,299,924,299,922,376,850,389" />
                    
                    
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-009" shape="poly" coords="777,333,838,334,839,384,780,390" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-049" shape="poly" coords="769,399,769,463,848,462,849,397" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-031" shape="poly" coords="856,397,856,479,922,468,923,394" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-057" shape="poly" coords="773,478,770,555,843,548,845,478" />
                    <area alt="" title="" href="/controlled-doc/sop/gen-021" shape="poly" coords="853,484,849,562,914,556,914,484" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/gen-038" shape="poly" coords="769,571,768,614,907,614,908,570" />
                    
                    <area alt="" title="" href="/controlled-doc/sop/its-001" shape="poly" coords="792,625,910,624,911,674,793,684" />      
                
            </map>
	
            <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
            <script type="text/javascript" src="/sites/default/files/js/jquery.maphilight.min.js"></script>
            <script type="text/javascript">$(function() {
                $(".map").maphilight({ "strokeWidth": 1, "strokeColor":"42859b", "fill": "B0E57C", "fillColor": "336699", "fillOpacity": 0.7, "singleSelect": true });
            });
            </script>'
        ;
 } 